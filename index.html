<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1E1E1E">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Glucose ML Monitor v2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', 'Roboto', sans-serif; background: #1E1E1E; color: #FFFFFF; overflow-x: hidden; -webkit-font-smoothing: antialiased; }
        .screen { display: none; min-height: 100vh; padding: 20px; padding-bottom: 80px; }
        .screen.active { display: block; }
        .header { background: #2C2C2C; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; font-weight: bold; color: #00FF00; }
        .session-badge { background: rgba(0, 255, 0, 0.2); color: #00FF00; padding: 5px 12px; border-radius: 20px; font-size: 12px; }
        .glucose-main { text-align: center; background: #2C2C2C; padding: 30px; border-radius: 16px; margin-bottom: 20px; }
        .glucose-value { font-size: 72px; font-weight: bold; color: #00FF00; font-family: 'Roboto Mono', monospace; }
        .glucose-unit { font-size: 24px; color: #B0B0B0; }
        .indicators { display: flex; justify-content: space-around; margin: 15px 0; flex-wrap: wrap; gap: 10px; }
        .indicator { font-size: 14px; color: #B0B0B0; }
        .indicator strong { color: #FFFFFF; }
        .chart-container { background: #2C2C2C; padding: 20px; border-radius: 12px; margin-bottom: 20px; height: 300px; position: relative; }
        .chart-title { font-size: 16px; font-weight: bold; margin-bottom: 15px; color: #00FF00; }
        .sensor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .footer-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #2C2C2C; display: grid; grid-template-columns: repeat(4, 1fr); padding: 10px; gap: 8px; box-shadow: 0 -2px 10px rgba(0,0,0,0.5); }
        .nav-btn { background: #333333; border: none; color: #FFFFFF; padding: 12px; border-radius: 8px; font-size: 12px; cursor: pointer; transition: all 0.3s; }
        .nav-btn:active, .nav-btn.active { transform: scale(0.95); background: #4CAF50; }
        .btn { background: #4CAF50; color: white; border: none; padding: 15px 25px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; margin: 10px 0; transition: all 0.3s; }
        .btn:active { transform: scale(0.98); background: #45a049; }
        .btn-primary { background: #00FF00; color: #1E1E1E; }
        .btn-secondary { background: #666666; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #B0B0B0; }
        .form-group input, .form-group select { width: 100%; padding: 12px; background: #333333; border: 1px solid #444444; border-radius: 8px; color: #FFFFFF; font-size: 16px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #00FF00; }
        .toggle-group { display: flex; gap: 10px; }
        .toggle-btn { flex: 1; padding: 12px; background: #333333; border: 2px solid #444444; border-radius: 8px; color: #FFFFFF; cursor: pointer; transition: all 0.3s; }
        .toggle-btn.active { background: #4CAF50; border-color: #4CAF50; }
        .card { background: #2C2C2C; padding: 20px; border-radius: 12px; margin-bottom: 15px; }
        .model-badge { display: inline-block; background: rgba(76, 175, 80, 0.2); color: #4CAF50; padding: 5px 12px; border-radius: 20px; font-size: 12px; margin: 5px; }
        .result-main { text-align: center; padding: 30px; }
        .result-value { font-size: 64px; font-weight: bold; color: #00FF00; }
        .category-badge { display: inline-block; padding: 10px 25px; border-radius: 25px; font-size: 18px; font-weight: bold; margin: 15px 0; }
        .category-normal { background: #4CAF50; color: white; }
        .category-prediabetes { background: #FFC107; color: #1E1E1E; }
        .category-diabetes { background: #F44336; color: white; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #2C2C2C; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 28px; font-weight: bold; color: #00FF00; }
        .stat-label { font-size: 12px; color: #B0B0B0; margin-top: 5px; }
        .video-preview { width: 100%; max-width: 400px; height: 300px; background: #000000; border-radius: 12px; margin: 20px auto; display: block; }
        .progress-bar { width: 100%; height: 8px; background: #333333; border-radius: 4px; overflow: hidden; margin: 15px 0; }
        .progress-fill { height: 100%; background: #00FF00; width: 0%; transition: width 0.3s; }
        .api-status { display: flex; align-items: center; gap: 10px; padding: 12px; background: #2C2C2C; border-radius: 8px; margin-bottom: 20px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #4CAF50; animation: pulse 2s infinite; }
        .status-dot.error { background: #F44336; }
        .status-dot.loading { background: #FFC107; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .recommendation { background: rgba(255, 193, 7, 0.1); border-left: 4px solid #FFC107; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .spinner { border: 4px solid #333333; border-top: 4px solid #00FF00; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .history-item { background: #2C2C2C; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .history-date { font-size: 12px; color: #B0B0B0; }
        .history-data { font-size: 16px; font-weight: bold; color: #00FF00; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .badge-ml { background: rgba(0, 255, 0, 0.2); color: #00FF00; }
        .badge-spo2 { background: rgba(33, 150, 243, 0.2); color: #2196F3; }
        .section-title { font-size: 18px; font-weight: bold; margin: 20px 0 15px 0; color: #00FF00; }
        .model-chart-container { height: 400px; }
        @media (max-width: 600px) { .glucose-value { font-size: 56px; } .chart-container { height: 250px; } .sensor-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<!-- PANTALLA 1: MONITOR PRINCIPAL -->
<div id="screen-monitor" class="screen active">
    <div class="header">
        <h1>ğŸ©¸ Glucose ML Monitor</h1>
        <div class="session-badge">ğŸŸ¢ SesiÃ³n: <span id="session-duration">00:00</span></div>
    </div>
    <div class="glucose-main">
        <div class="glucose-value"><span id="main-glucose">137</span><span class="glucose-unit">mg/dL</span></div>
        <div style="color: #B0B0B0; margin-top: 10px;">Ãšltima actualizaciÃ³n: <span id="last-update">Ahora</span></div>
    </div>
    <div class="indicators">
        <div class="indicator">SpO2: <strong id="spo2-display">98%</strong></div>
        <div class="indicator">FC: <strong id="fc-display">75 bpm</strong></div>
        <div class="indicator">Actividad: <strong>ğŸƒ ACTIVO</strong></div>
    </div>
    <div class="api-status">
        <div class="status-dot" id="api-status-dot"></div>
        <div style="flex: 1;">
            <div style="font-size: 12px; color: #B0B0B0;" id="api-status-text">Verificando conexiÃ³n...</div>
            <div style="font-size: 10px; color: #666;">https://glucose-ml-monitor.onrender.com</div>
            <div style="font-size: 10px; color: #00FF00;" id="api-models-text"></div>
        </div>
    </div>
    <div class="chart-container">
        <div class="chart-title">ğŸ“ˆ Glucosa (Ãšltimas 24h)</div>
        <canvas id="glucoseChart"></canvas>
    </div>
    <div class="sensor-grid">
        <div class="chart-container">
            <div class="chart-title">ğŸ“± AcelerÃ³metro (m/sÂ²)</div>
            <canvas id="accelChart"></canvas>
        </div>
        <div class="chart-container">
            <div class="chart-title">ğŸ”„ Giroscopio (Â°/s)</div>
            <canvas id="gyroChart"></canvas>
        </div>
    </div>
    <div class="footer-nav">
        <button class="nav-btn active" onclick="showScreen('monitor')">ğŸ“Š<br>Monitor</button>
        <button class="nav-btn" onclick="showScreen('measurement')">ğŸ“¸<br>MediciÃ³n</button>
        <button class="nav-btn" onclick="showScreen('evaluation')">ğŸ§¬<br>Eval ML</button>
        <button class="nav-btn" onclick="showScreen('history')">ğŸ“‹<br>Historial</button>
    </div>
</div>

<!-- PANTALLA 2: NUEVA MEDICIÃ“N -->
<div id="screen-measurement" class="screen">
    <div class="header">
        <button onclick="showScreen('monitor')" style="background: none; border: none; color: #00FF00; cursor: pointer;">â† Volver</button>
        <h1>ğŸ“¸ Nueva MediciÃ³n</h1>
    </div>
    <div class="card">
        <h3>MediciÃ³n de SpO2 y Frecuencia CardÃ­aca</h3>
        <p style="color: #B0B0B0; margin: 10px 0;">Coloca tu dedo sobre la cÃ¡mara trasera y el flash</p>
        <video id="videoPreview" class="video-preview" autoplay playsinline style="display: none;"></video>
        <div id="captureCountdown" style="text-align: center; padding: 40px; display: none;">
            <div style="font-size: 72px; font-weight: bold; color: #00FF00;" id="countdownNumber">10</div>
            <div style="color: #B0B0B0;">Manteniendo el dedo en la cÃ¡mara...</div>
            <div class="progress-bar"><div class="progress-fill" id="captureProgress"></div></div>
        </div>
        <div id="captureResults" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="measured-spo2">--</div><div class="stat-label">SpO2 (%)</div></div>
                <div class="stat-card"><div class="stat-value" id="measured-fc">--</div><div class="stat-label">FC (bpm)</div></div>
            </div>
            <div style="text-align: center; color: #B0B0B0;">
                <p>Calidad de seÃ±al: <strong style="color: #4CAF50;">Alta</strong></p>
                <p id="measurement-time">--</p>
            </div>
        </div>
        <button class="btn btn-primary" id="btnStartCapture" onclick="startCapture()">ğŸ“¸ INICIAR CAPTURA</button>
        <button class="btn" id="btnSaveMeasurement" onclick="saveMeasurement()" style="display: none;">ğŸ’¾ Guardar en Historial</button>
    </div>
    <div class="footer-nav">
        <button class="nav-btn" onclick="showScreen('monitor')">ğŸ“Š<br>Monitor</button>
        <button class="nav-btn active" onclick="showScreen('measurement')">ğŸ“¸<br>MediciÃ³n</button>
        <button class="nav-btn" onclick="showScreen('evaluation')">ğŸ§¬<br>Eval ML</button>
        <button class="nav-btn" onclick="showScreen('history')">ğŸ“‹<br>Historial</button>
    </div>
</div>

<!-- PANTALLA 3: EVALUACIÃ“N ML -->
<div id="screen-evaluation" class="screen">
    <div class="header">
        <button onclick="showScreen('monitor')" style="background: none; border: none; color: #00FF00; cursor: pointer;">â† Volver</button>
        <h1>ğŸ§¬ EvaluaciÃ³n ML</h1>
    </div>
    <div class="api-status">
        <div class="status-dot" id="api-status-dot-eval"></div>
        <div style="flex: 1;">
            <div style="font-size: 12px; color: #B0B0B0;">Conectado a API</div>
            <div style="font-size: 10px; color: #666;">https://glucose-ml-monitor.onrender.com</div>
        </div>
    </div>
    <div class="card">
        <h3 style="margin-bottom: 15px;">7 Modelos ML Disponibles</h3>
        <span class="model-badge">âœ… XGBoost</span>
        <span class="model-badge">âœ… RandomForest</span>
        <span class="model-badge">âœ… LightGBM</span>
        <span class="model-badge">âœ… GradientBoosting</span>
        <span class="model-badge">âœ… Ridge</span>
        <span class="model-badge">âœ… Lasso</span>
        <span class="model-badge">âœ… ElasticNet</span>
    </div>
    <form id="evaluationForm">
        <div class="section-title">ğŸ“‹ DATOS PERSONALES</div>
        <div class="form-group"><label>Edad *</label><input type="number" id="edad" min="18" max="100" placeholder="Ingrese su edad" required></div>
        <div class="form-group"><label>Sexo *</label><select id="sexo" required><option value="" disabled selected>Seleccione...</option><option value="Masculino">Masculino</option><option value="Femenino">Femenino</option></select></div>
        <div class="section-title">âš–ï¸ DATOS ANTROPOMÃ‰TRICOS</div>
        <div class="form-group"><label>Peso (kg) *</label><input type="number" step="0.1" id="peso" placeholder="Ej: 75.5" required></div>
        <div class="form-group"><label>Talla (m) *</label><input type="number" step="0.01" id="talla" placeholder="Ej: 1.70" required></div>
        <div class="form-group"><label>IMC (calculado automÃ¡ticamente)</label><input type="number" step="0.1" id="imc" readonly style="background: #4d4d00;" placeholder="Se calcula al ingresar peso/talla"></div>
        <div class="form-group"><label>PerÃ­metro Cintura (cm) *</label><input type="number" id="cintura" placeholder="Ej: 90" required></div>
        <div class="section-title">ğŸ’“ SIGNOS VITALES</div>
        <div class="form-group"><label>SpO2 (%)</label><input type="number" id="eval-spo2" placeholder="Ej: 98" min="80" max="100"></div>
        <div class="form-group"><label>Frecuencia CardÃ­aca (bpm)</label><input type="number" id="eval-fc" placeholder="Ej: 75" min="40" max="200"></div>
        <div class="section-title">ğŸƒ ESTILO DE VIDA</div>
        <div class="form-group"><label>Actividad FÃ­sica Regular</label><div class="toggle-group"><button type="button" class="toggle-btn" onclick="toggleOption(this, 'actividad', 'si')">âœ… SÃ­</button><button type="button" class="toggle-btn" onclick="toggleOption(this, 'actividad', 'no')">âŒ No</button></div></div>
        <div class="form-group"><label>Consumo Diario de Frutas/Verduras</label><div class="toggle-group"><button type="button" class="toggle-btn" onclick="toggleOption(this, 'frutas', 'si')">âœ… SÃ­</button><button type="button" class="toggle-btn" onclick="toggleOption(this, 'frutas', 'no')">âŒ No</button></div></div>
        <div class="section-title">ğŸ¥ ANTECEDENTES MÃ‰DICOS</div>
        <div class="form-group"><label>Â¿Tiene HipertensiÃ³n?</label><div class="toggle-group"><button type="button" class="toggle-btn" onclick="toggleOption(this, 'hipertension', 'si')">SÃ­</button><button type="button" class="toggle-btn" onclick="toggleOption(this, 'hipertension', 'no')">No</button></div></div>
        <div class="form-group"><label>Â¿Tiene Diabetes Diagnosticada?</label><div class="toggle-group"><button type="button" class="toggle-btn" onclick="toggleOption(this, 'diabetes', 'si')">SÃ­</button><button type="button" class="toggle-btn" onclick="toggleOption(this, 'diabetes', 'no')">No</button></div></div>
        <div class="section-title">ğŸ“Š EVALUACIÃ“N DE RIESGO</div>
        <div class="form-group"><label>Puntaje FINDRISC (0-26)</label><input type="number" id="findrisc" min="0" max="26" placeholder="Ej: 10" required></div>
        <button type="submit" class="btn btn-primary" id="btnPredict">ğŸ§¬ PREDECIR CON 7 MODELOS ML</button>
    </form>
    <div class="footer-nav">
        <button class="nav-btn" onclick="showScreen('monitor')">ğŸ“Š<br>Monitor</button>
        <button class="nav-btn" onclick="showScreen('measurement')">ğŸ“¸<br>MediciÃ³n</button>
        <button class="nav-btn active" onclick="showScreen('evaluation')">ğŸ§¬<br>Eval ML</button>
        <button class="nav-btn" onclick="showScreen('history')">ğŸ“‹<br>Historial</button>
    </div>
</div>

<!-- PANTALLA 4: RESULTADOS ML -->
<div id="screen-results" class="screen">
    <div class="header">
        <button onclick="showScreen('evaluation')" style="background: none; border: none; color: #00FF00; cursor: pointer;">â† Volver</button>
        <h1>ğŸ“Š Resultados ML</h1>
    </div>
    <div class="result-main">
        <div style="font-size: 14px; color: #B0B0B0; margin-bottom: 5px;">â­ Modelo MÃ¡s Acertado</div>
        <div style="font-size: 24px; font-weight: bold; color: #00FF00; margin-bottom: 10px;" id="best-model-name">---</div>
        <div class="result-value" id="result-glucose">---<span style="font-size: 32px;"> mg/dL</span></div>
        <div class="category-badge category-prediabetes" id="result-category">---</div>
        <div style="margin-top: 15px;"><span style="color: #B0B0B0;">Riesgo: </span><strong style="color: #FFC107;" id="result-risk">---</strong></div>
        <div style="margin-top: 10px;"><span style="color: #B0B0B0;">Confianza: </span><strong style="color: #4CAF50;" id="result-confidence">---</strong></div>
    </div>
    <div class="card">
        <h3>ğŸ“Š MÃ©tricas del AnÃ¡lisis</h3>
        <p style="color: #B0B0B0; margin: 10px 0;">Promedio Ensemble (7 modelos): <strong style="color: #FFF;" id="ensemble-value">---</strong></p>
        <p style="color: #B0B0B0; margin: 10px 0;">Error Esperado (MAE): <strong style="color: #FFF;">Â± 8.2 mg/dL</strong></p>
        <p style="color: #B0B0B0; margin: 10px 0;">Rango de Confianza: <strong style="color: #FFF;" id="result-range">---</strong></p>
    </div>
    <div class="chart-container model-chart-container">
        <div class="chart-title">ğŸ¤– Otros Modelos ML</div>
        <canvas id="modelsChart"></canvas>
    </div>
    <div class="recommendation">
        <h4 style="color: #FFC107; margin-bottom: 10px;">ğŸ’¡ RecomendaciÃ³n</h4>
        <p id="recommendation-text">---</p>
    </div>
    <button class="btn" onclick="saveMLEvaluation()">ğŸ’¾ Guardar en Historial</button>
    <button class="btn btn-secondary" onclick="showScreen('evaluation')">ğŸ”„ Nueva EvaluaciÃ³n</button>
    <div class="footer-nav">
        <button class="nav-btn" onclick="showScreen('monitor')">ğŸ“Š<br>Monitor</button>
        <button class="nav-btn" onclick="showScreen('measurement')">ğŸ“¸<br>MediciÃ³n</button>
        <button class="nav-btn active" onclick="showScreen('evaluation')">ğŸ§¬<br>Eval ML</button>
        <button class="nav-btn" onclick="showScreen('history')">ğŸ“‹<br>Historial</button>
    </div>
</div>

<!-- PANTALLA 5: HISTORIAL -->
<div id="screen-history" class="screen">
    <div class="header">
        <button onclick="showScreen('monitor')" style="background: none; border: none; color: #00FF00; cursor: pointer;">â† Volver</button>
        <h1>ğŸ“Š Historial</h1>
    </div>
    <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="total-measurements">0</div><div class="stat-label">Total Mediciones</div></div>
        <div class="stat-card"><div class="stat-value" id="avg-glucose">--</div><div class="stat-label">Promedio Glucosa</div></div>
    </div>
    <div class="card">
        <h3 style="margin-bottom: 15px;">Registros Recientes</h3>
        <div id="history-list"><div style="text-align: center; color: #B0B0B0; padding: 40px;">Sin registros aÃºn.</div></div>
    </div>
    <button class="btn" onclick="exportHistoryCSV()">ğŸ“¥ Exportar Todo a CSV</button>
    <div class="footer-nav">
        <button class="nav-btn" onclick="showScreen('monitor')">ğŸ“Š<br>Monitor</button>
        <button class="nav-btn" onclick="showScreen('measurement')">ğŸ“¸<br>MediciÃ³n</button>
        <button class="nav-btn" onclick="showScreen('evaluation')">ğŸ§¬<br>Eval ML</button>
        <button class="nav-btn active" onclick="showScreen('history')">ğŸ“‹<br>Historial</button>
    </div>
</div>

<script>
const API_BASE_URL = 'https://glucose-ml-monitor.onrender.com';
let currentScreen = 'monitor';
let sessionStartTime = new Date();
let historyData = [];
let lastMLResult = null;
let lastMeasurement = { spo2: 98, fc: 75 };
let formData = { actividad: '', frutas: '', hipertension: '', diabetes: '' };
let glucoseChart, accelChart, gyroChart, modelsChart;
let accelData = { x: [], y: [], z: [], labels: [] };
let gyroData = { alpha: [], beta: [], gamma: [], labels: [] };

window.addEventListener('DOMContentLoaded', () => {
    initCharts();
    initSensors();
    checkAPIHealth();
    setInterval(updateSessionDuration, 1000);
    document.getElementById('peso').addEventListener('input', calculateIMC);
    document.getElementById('talla').addEventListener('input', calculateIMC);
    document.getElementById('evaluationForm').addEventListener('submit', (e) => { e.preventDefault(); predictWithML(); });
    loadHistoryFromStorage();
});

async function checkAPIHealth() {
    const dot = document.getElementById('api-status-dot');
    const text = document.getElementById('api-status-text');
    const models = document.getElementById('api-models-text');
    dot.className = 'status-dot loading';
    text.textContent = 'Verificando conexiÃ³n...';
    try {
        const res = await fetch(`${API_BASE_URL}/health`);
        const data = await res.json();
        dot.className = 'status-dot';
        text.textContent = 'Conectado a API';
        models.textContent = `âœ… ${data.models_loaded || 7} modelos cargados`;
    } catch (e) {
        dot.className = 'status-dot error';
        text.textContent = 'Sin conexiÃ³n a API';
        models.textContent = 'âŒ Error: ' + e.message;
    }
}

function showScreen(name) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('screen-' + name).classList.add('active');
    currentScreen = name;
}

function updateSessionDuration() {
    const d = Math.floor((Date.now() - sessionStartTime) / 1000);
    document.getElementById('session-duration').textContent = `${Math.floor(d/60).toString().padStart(2,'0')}:${(d%60).toString().padStart(2,'0')}`;
}

function calculateIMC() {
    const peso = parseFloat(document.getElementById('peso').value);
    const talla = parseFloat(document.getElementById('talla').value);
    if (peso && talla > 0) document.getElementById('imc').value = (peso / (talla * talla)).toFixed(2);
}

function toggleOption(btn, field, value) {
    btn.parentElement.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    formData[field] = value;
}

async function predictWithML() {
    const btn = document.getElementById('btnPredict');
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner" style="width:20px;height:20px;display:inline-block;margin-right:10px;"></div> Consultando API...';
    
    // IMPORTANTE: Enviar en MINÃšSCULAS para coincidir con el backend
    const payload = {
        edad: parseInt(document.getElementById('edad').value) || 0,
        sexo: document.getElementById('sexo').value || 'Masculino',
        peso: parseFloat(document.getElementById('peso').value) || 0,
        talla: parseFloat(document.getElementById('talla').value) || 0,
        imc: parseFloat(document.getElementById('imc').value) || 0,
        perimetro_cintura: parseInt(document.getElementById('cintura').value) || 0,
        spo2: parseInt(document.getElementById('eval-spo2').value) || 98,
        frecuencia_cardiaca: parseInt(document.getElementById('eval-fc').value) || 75,
        actividad_fisica: formData.actividad.toLowerCase() || 'no',
        consumo_frutas: formData.frutas.toLowerCase() || 'no',
        tiene_hipertension: formData.hipertension.toLowerCase() || 'no',
        tiene_diabetes: formData.diabetes.toLowerCase() || 'no',
        puntaje_findrisc: parseInt(document.getElementById('findrisc').value) || 0
    };
    
    console.log('ğŸ“¤ Payload:', JSON.stringify(payload, null, 2));
    
    try {
        const res = await fetch(`${API_BASE_URL}/predict`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(`API Error ${res.status}: ${await res.text()}`);
        const result = await res.json();
        console.log('ğŸ“¥ Respuesta:', result);
        lastMLResult = result;
        displayMLResults(result);
        showScreen('results');
    } catch (e) {
        console.error('âŒ Error:', e);
        alert('âŒ Error: ' + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ§¬ PREDECIR CON 7 MODELOS ML';
    }
}

function displayMLResults(result) {
    const preds = result.predicciones_individuales || {};
    const ensemble = result.prediccion_final || 0;
    let bestModel = result.mejor_modelo || '', bestValue = ensemble;
    
    if (!bestModel && Object.keys(preds).length > 0) {
        let minDiff = Infinity;
        for (const [k, v] of Object.entries(preds)) {
            const diff = Math.abs(Number(v) - ensemble);
            if (diff < minDiff) { minDiff = diff; bestModel = k; bestValue = Number(v); }
        }
    } else if (bestModel && preds[bestModel]) {
        bestValue = Number(preds[bestModel]);
    }
    
    document.getElementById('best-model-name').textContent = bestModel || 'Ensemble';
    document.getElementById('result-glucose').innerHTML = Math.round(bestValue) + '<span style="font-size:32px;"> mg/dL</span>';
    
    let cat = 'Normal', risk = 'Bajo';
    if (bestValue >= 126) { cat = 'Diabetes'; risk = 'Alto'; }
    else if (bestValue >= 100) { cat = 'Prediabetes'; risk = 'Moderado'; }
    
    const catEl = document.getElementById('result-category');
    catEl.textContent = result.categoria || cat;
    catEl.className = 'category-badge category-' + (result.categoria || cat).toLowerCase();
    
    document.getElementById('result-risk').textContent = risk;
    document.getElementById('result-confidence').textContent = ((result.confidence || 0.85) * 100).toFixed(0) + '%';
    document.getElementById('main-glucose').textContent = Math.round(bestValue);
    document.getElementById('ensemble-value').textContent = Math.round(ensemble) + ' mg/dL';
    
    const rango = result.intervalo_confianza;
    if (Array.isArray(rango)) document.getElementById('result-range').textContent = `${rango[0]} - ${rango[1]} mg/dL`;
    else document.getElementById('result-range').textContent = 'N/A';
    
    document.getElementById('recommendation-text').textContent = result.recomendacion || 
        (cat === 'Diabetes' ? 'Consulta a un profesional de salud.' : 
         cat === 'Prediabetes' ? 'Refuerza actividad fÃ­sica y controla carbohidratos.' : 
         'ContinÃºa con hÃ¡bitos saludables.');
    
    createModelsChart(preds, bestModel);
}

function createModelsChart(preds, bestModel) {
    const ctx = document.getElementById('modelsChart').getContext('2d');
    if (modelsChart) modelsChart.destroy();
    const others = {};
    for (const [k, v] of Object.entries(preds)) if (k !== bestModel) others[k] = v;
    const labels = Object.keys(others);
    const data = Object.values(others).map(v => Math.round(Number(v)));
    if (labels.length === 0) return;
    modelsChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Glucosa (mg/dL)', data, backgroundColor: '#4CAF50', borderColor: '#2E7D32', borderWidth: 2 }] },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: false, min: Math.min(...data) - 20, max: Math.max(...data) + 20, ticks: { color: '#B0B0B0' }, grid: { color: '#333' } }, y: { ticks: { color: '#B0B0B0', font: { size: 11 } }, grid: { color: '#333' } } } }
    });
}

function initCharts() {
    glucoseChart = new Chart(document.getElementById('glucoseChart').getContext('2d'), {
        type: 'line',
        data: { labels: ['00:00','04:00','08:00','12:00','16:00','20:00','Ahora'], datasets: [{ label: 'Glucosa', data: [115,118,125,140,135,130,137], borderColor: '#00FF00', backgroundColor: 'rgba(0,255,0,0.1)', tension: 0.4, fill: true }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { min: 80, max: 180, ticks: { color: '#B0B0B0' }, grid: { color: '#333' } }, x: { ticks: { color: '#B0B0B0' }, grid: { color: '#333' } } } }
    });
    accelChart = new Chart(document.getElementById('accelChart').getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'X', data: [], borderColor: '#FF5252', pointRadius: 0 }, { label: 'Y', data: [], borderColor: '#2196F3', pointRadius: 0 }, { label: 'Z', data: [], borderColor: '#4CAF50', pointRadius: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#B0B0B0', boxWidth: 12 } } }, scales: { y: { min: -20, max: 20, ticks: { color: '#B0B0B0' }, grid: { color: '#333' } }, x: { display: false } }, animation: false }
    });
    gyroChart = new Chart(document.getElementById('gyroChart').getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Alpha', data: [], borderColor: '#FF9800', pointRadius: 0 }, { label: 'Beta', data: [], borderColor: '#9C27B0', pointRadius: 0 }, { label: 'Gamma', data: [], borderColor: '#00BCD4', pointRadius: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#B0B0B0', boxWidth: 12 } } }, scales: { y: { min: -180, max: 180, ticks: { color: '#B0B0B0' }, grid: { color: '#333' } }, x: { display: false } }, animation: false }
    });
}

function initSensors() {
    if (window.DeviceMotionEvent) window.addEventListener('devicemotion', e => {
        const x = e.accelerationIncludingGravity?.x || 0, y = e.accelerationIncludingGravity?.y || 0, z = e.accelerationIncludingGravity?.z || 0;
        if (accelData.x.length > 30) { accelData.x.shift(); accelData.y.shift(); accelData.z.shift(); accelData.labels.shift(); }
        accelData.x.push(+x.toFixed(2)); accelData.y.push(+y.toFixed(2)); accelData.z.push(+z.toFixed(2)); accelData.labels.push('');
        if (accelChart && accelData.x.length % 5 === 0) { accelChart.data.labels = accelData.labels; accelChart.data.datasets[0].data = accelData.x; accelChart.data.datasets[1].data = accelData.y; accelChart.data.datasets[2].data = accelData.z; accelChart.update('none'); }
    });
    if (window.DeviceOrientationEvent) window.addEventListener('deviceorientation', e => {
        const a = e.alpha || 0, b = e.beta || 0, g = e.gamma || 0;
        if (gyroData.alpha.length > 30) { gyroData.alpha.shift(); gyroData.beta.shift(); gyroData.gamma.shift(); gyroData.labels.shift(); }
        gyroData.alpha.push(+a.toFixed(2)); gyroData.beta.push(+b.toFixed(2)); gyroData.gamma.push(+g.toFixed(2)); gyroData.labels.push('');
        if (gyroChart && gyroData.alpha.length % 5 === 0) { gyroChart.data.labels = gyroData.labels; gyr
